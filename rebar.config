{erl_opts, [
    debug_info,
    warn_export_vars,
    warn_shadow_vars,
    warn_obsolete_guard,
    {platform_define, "^[0-9]+", namespaced_types}
]}.

{minimum_otp_vsn, "26"}.

{deps, []}.

{profiles, [
    {test, [
        {deps, [
            {proper, "1.4.0"}
        ]},
        {erl_opts, [debug_info, nowarn_export_all]}
    ]},
    {interop_client, [
        {escript_main_app, quic},
        {escript_name, quic_interop_client},
        {escript_emu_args, "%%! -escript main quic_interop_client\n"}
    ]},
    {interop_server, [
        {escript_main_app, quic},
        {escript_name, quic_interop_server},
        {escript_emu_args, "%%! -escript main quic_interop_server\n"}
    ]}
]}.

{project_plugins, [
    {rebar3_proper, "~> 0.12"},
    {rebar3_hex, "~> 7.0"},
    {rebar3_ex_doc, "~> 0.2"},
    {rebar3_lint, "~> 4.2"},
    {erlfmt, "~> 1.7"}
]}.

{hex, [{doc, ex_doc}]}.

{ex_doc, [
    {source_url, <<"https://github.com/benoitc/erlang_quic">>},
    {extras, [
        <<"README.md">>,
        <<"docs/DESIGN.md">>
    ]},
    {main, <<"readme">>},
    {groups_for_modules, [
        {<<"Public API">>, [quic, quic_listener]},
        {<<"Connection">>, [quic_connection, quic_stream]},
        {<<"Protocol">>, [quic_packet, quic_frame, quic_varint]},
        {<<"Cryptography">>, [quic_crypto, quic_tls, quic_keys, quic_aead, quic_hkdf]},
        {<<"Flow Control">>, [quic_flow, quic_cc, quic_loss, quic_ack]},
        {<<"Session">>, [quic_ticket]}
    ]}
]}.

{erlfmt, [
    write,
    {files, [
        "{src,test,include,scripts}/**/*.{hrl,erl,app.src,escript}",
        "erldns.example.config",
        "rebar.config"
    ]}
]}.

{elvis, [
    #{
        filter => "*.erl",
        dirs => ["src/**"],
        rules =>
            [
                %% Keep
                {elvis_style, no_macros, disable},
                {elvis_style, state_record_and_type, #{
                    ignore => [
                        quic_listener, quic_listener_manager, quic_server_registry, quic_connection
                    ]
                }},
                {elvis_style, private_data_types, #{
                    ignore => [quic_keys, quic_loss, quic_packet, quic_ticket, quic_lb]
                }},
                {elvis_style, no_receive_without_timeout, #{
                    ignore => [quic_interop_server]
                }},
                {elvis_style, no_debug_call, #{
                    ignore => [quic_interop_client, quic_interop_server]
                }},
                {elvis_style, atom_naming_convention, #{
                    % public_key record field names need this
                    regex => "^[a-z](_?[a-zA-Z0-9]+)*(_SUITE)?$"
                }},
                %% Since OTP28
                {elvis_style, prefer_strict_generators, disable},
                %% Disable rules that are too strict for this codebase
                {elvis_style, no_common_caveats_call, disable},
                {elvis_style, no_init_lists, disable},
                {elvis_style, no_spec_with_records, disable},
                {elvis_style, param_pattern_matching, disable},
                {elvis_style, no_used_ignored_variables, disable},
                {elvis_text_style, line_length, #{limit => 120}},
                {elvis_style, no_if_expression, #{ignore => [quic_stream, quic_connection]}},
                {elvis_style, no_deep_nesting, #{
                    ignore => [quic_listener, quic_interop_client, quic_connection]
                }},
                {elvis_style, variable_naming_convention, #{ignore => [quic_tls]}},
                {elvis_style, variable_casing, #{ignore => [quic_tls, quic_connection]}},
                %% TODO: Per-module ignores; to be fixed later
                {elvis_style, dont_repeat_yourself, #{
                    ignore => [
                        quic_connection,
                        quic_cc,
                        quic_aead,
                        quic_packet,
                        quic_interop_client,
                        quic_tls
                    ]
                }},
                {elvis_style, max_function_length, #{
                    ignore =>
                        [
                            quic_ack,
                            quic_cc,
                            quic_connection,
                            quic_frame,
                            quic_interop_client,
                            quic_lb,
                            quic_listener,
                            quic_loss,
                            quic_packet,
                            quic_stream,
                            quic_tls
                        ]
                }},
                {elvis_style, no_god_modules, #{
                    ignore => [quic, quic_connection, quic_crypto, quic_stream]
                }},
                {elvis_style, max_function_clause_length, #{
                    ignore =>
                        [
                            quic_ack,
                            quic_connection,
                            quic_interop_client,
                            quic_lb,
                            quic_listener,
                            quic_packet,
                            quic_stream,
                            quic_tls,
                            quic_loss
                        ]
                }},
                {elvis_style, max_module_length, #{
                    ignore => [quic_connection, quic_interop_client, quic_tls]
                }},
                {elvis_style, max_record_fields, #{ignore => [quic_connection]}}
            ],
        ruleset => erl_files_strict
    },
    #{
        filter => "*.hrl",
        dirs => ["include"],
        ruleset => hrl_files
    },
    #{
        filter => "rebar.config",
        dirs => ["."],
        ruleset => rebar_config
    }
]}.

{dialyzer, [
    {warnings, [
        error_handling,
        unknown
    ]},
    {plt_apps, all_deps},
    {plt_extra_apps, [crypto, ssl]}
]}.

{xref_checks, [
    undefined_function_calls,
    undefined_functions,
    deprecated_function_calls,
    deprecated_functions
]}.

{cover_enabled, true}.
{cover_opts, [verbose]}.

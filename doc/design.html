<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.39.1">
    <meta name="project" content="quic v0.6.5">


    <title>erlang_quic Design Document — quic v0.6.5</title>

    <link rel="stylesheet" href="dist/html-erlang-7YNYEB7F.css" />

    <script defer src="dist/sidebar_items-4DFDAA73.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-HBZYRXZS.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
quic
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.6.5
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of quic</span>
            <div class="search-input-wrapper">
              <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
              <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
                <i class="ri-close-line ri-lg" title="Cancel search"></i>
              </button>
            </div>
          </label>
        </form>
        <div class="autocomplete">
        </div>
        <div class="engine-selector" data-multiple="false">
          <button type="button" class="engine-button" aria-label="Select search engine" aria-haspopup="true" aria-expanded="false">
            <i class="ri-search-2-line" aria-hidden="true"></i>
            <span class="engine-name">Default</span>
            <i class="ri-arrow-down-s-line" aria-hidden="true"></i>
          </button>
          <div class="engine-dropdown" hidden role="menu">

              <button type="button"
                      class="engine-option"
                      data-engine-url="search.html?q="
                      role="menuitemradio"
                      aria-checked="true">
                <span class="name">Default</span>
                <span class="help">In-browser search</span>
              </button>

          </div>
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>erlang_quic Design Document</h1>


      <a href="https://github.com/benoitc/erlang_quic/blob/v0.6.5/docs/DESIGN.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>This document describes the architecture and design of the erlang_quic implementation.</p><h2 id="architecture-overview" class="section-heading"><a href="#architecture-overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture Overview</span></h2><p>The implementation is organized into the following module groups:</p><h3 id="public-api-layer" class="section-heading"><a href="#public-api-layer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Public API Layer</span></h3><table><thead><tr><th style="text-align: left;">Module</th><th style="text-align: left;">Responsibility</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">quic</code></td><td style="text-align: left;">Main public API for client connections</td></tr><tr><td style="text-align: left;"><code class="inline">quic_listener</code></td><td style="text-align: left;">Server-side listener for accepting connections</td></tr></tbody></table><h3 id="connection-layer" class="section-heading"><a href="#connection-layer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Connection Layer</span></h3><table><thead><tr><th style="text-align: left;">Module</th><th style="text-align: left;">Responsibility</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">quic_connection</code></td><td style="text-align: left;">Connection state machine (gen_statem)</td></tr><tr><td style="text-align: left;"><code class="inline">quic_stream</code></td><td style="text-align: left;">Stream state management</td></tr></tbody></table><h3 id="protocol-layer" class="section-heading"><a href="#protocol-layer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Protocol Layer</span></h3><table><thead><tr><th style="text-align: left;">Module</th><th style="text-align: left;">Responsibility</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">quic_packet</code></td><td style="text-align: left;">Packet encoding/decoding</td></tr><tr><td style="text-align: left;"><code class="inline">quic_frame</code></td><td style="text-align: left;">Frame encoding/decoding</td></tr><tr><td style="text-align: left;"><code class="inline">quic_varint</code></td><td style="text-align: left;">Variable-length integer encoding (RFC 9000 Section 16)</td></tr></tbody></table><h3 id="cryptography-layer" class="section-heading"><a href="#cryptography-layer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Cryptography Layer</span></h3><table><thead><tr><th style="text-align: left;">Module</th><th style="text-align: left;">Responsibility</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">quic_crypto</code></td><td style="text-align: left;">Key derivation and transcript hashing</td></tr><tr><td style="text-align: left;"><code class="inline">quic_tls</code></td><td style="text-align: left;">TLS 1.3 message building and parsing</td></tr><tr><td style="text-align: left;"><code class="inline">quic_keys</code></td><td style="text-align: left;">Traffic key derivation</td></tr><tr><td style="text-align: left;"><code class="inline">quic_aead</code></td><td style="text-align: left;">AEAD encryption/decryption and header protection</td></tr><tr><td style="text-align: left;"><code class="inline">quic_hkdf</code></td><td style="text-align: left;">HKDF-based key expansion</td></tr></tbody></table><h3 id="flow-control-layer" class="section-heading"><a href="#flow-control-layer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Flow Control Layer</span></h3><table><thead><tr><th style="text-align: left;">Module</th><th style="text-align: left;">Responsibility</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">quic_flow</code></td><td style="text-align: left;">Connection and stream flow control</td></tr><tr><td style="text-align: left;"><code class="inline">quic_cc</code></td><td style="text-align: left;">Congestion control (NewReno)</td></tr><tr><td style="text-align: left;"><code class="inline">quic_loss</code></td><td style="text-align: left;">Loss detection and recovery</td></tr><tr><td style="text-align: left;"><code class="inline">quic_ack</code></td><td style="text-align: left;">ACK frame processing and generation</td></tr></tbody></table><h3 id="session-layer" class="section-heading"><a href="#session-layer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Session Layer</span></h3><table><thead><tr><th style="text-align: left;">Module</th><th style="text-align: left;">Responsibility</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">quic_ticket</code></td><td style="text-align: left;">Session ticket storage and PSK derivation</td></tr></tbody></table><h2 id="connection-lifecycle" class="section-heading"><a href="#connection-lifecycle" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Connection Lifecycle</span></h2><pre><code class="makeup erlang" translate="no"><span class="w">                    </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                    </span><span class="err">│</span><span class="w">  </span><span class="ss">idle</span><span class="w">   </span><span class="err">│</span><span class="w">
                    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                         </span><span class="err">│</span><span class="w"> </span><span class="nb">send</span><span class="w"> </span><span class="n">ClientHello</span><span class="w">
                         </span><span class="err">▼</span><span class="w">
                  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                  </span><span class="err">│</span><span class="w"> </span><span class="ss">handshaking</span><span class="w">  </span><span class="err">│</span><span class="w">
                  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                         </span><span class="err">│</span><span class="w"> </span><span class="k">receive</span><span class="w"> </span><span class="ss">server</span><span class="w"> </span><span class="n">Finished</span><span class="w">
                         </span><span class="err">│</span><span class="w"> </span><span class="nb">send</span><span class="w"> </span><span class="ss">client</span><span class="w"> </span><span class="n">Finished</span><span class="w">
                         </span><span class="err">▼</span><span class="w">
                  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                  </span><span class="err">│</span><span class="w">  </span><span class="ss">connected</span><span class="w">   </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">         </span><span class="err">│</span><span class="w">
                         </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w"> </span><span class="ss">key</span><span class="w"> </span><span class="ss">update</span><span class="w">
                         </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w"> </span><span class="ss">migration</span><span class="w">
                         </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                         </span><span class="err">│</span><span class="w"> </span><span class="ss">close</span><span class="o">/</span><span class="ss">error</span><span class="w">
                         </span><span class="err">▼</span><span class="w">
                  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                  </span><span class="err">│</span><span class="w">   </span><span class="ss">draining</span><span class="w">   </span><span class="err">│</span><span class="w">
                  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                         </span><span class="err">│</span><span class="w"> </span><span class="ss">drain</span><span class="w"> </span><span class="ss">timeout</span><span class="w">
                         </span><span class="err">▼</span><span class="w">
                    </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                    </span><span class="err">│</span><span class="w"> </span><span class="ss">closed</span><span class="w">  </span><span class="err">│</span><span class="w">
                    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h3 id="state-descriptions" class="section-heading"><a href="#state-descriptions" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">State Descriptions</span></h3><ul><li><strong>idle</strong>: Initial state, preparing to connect</li><li><strong>handshaking</strong>: TLS 1.3 handshake in progress</li><li><strong>connected</strong>: Connection established, data transfer active</li><li><strong>draining</strong>: Connection closing, processing remaining packets</li><li><strong>closed</strong>: Connection terminated</li></ul><h2 id="packet-processing" class="section-heading"><a href="#packet-processing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Packet Processing</span></h2><h3 id="encryption-levels" class="section-heading"><a href="#encryption-levels" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Encryption Levels</span></h3><p>QUIC uses four encryption levels, each with its own keys:</p><table><thead><tr><th style="text-align: left;">Level</th><th style="text-align: left;">Usage</th></tr></thead><tbody><tr><td style="text-align: left;">Initial</td><td style="text-align: left;">ClientHello, ServerHello (derived from DCID)</td></tr><tr><td style="text-align: left;">Handshake</td><td style="text-align: left;">EncryptedExtensions through Finished</td></tr><tr><td style="text-align: left;">0-RTT</td><td style="text-align: left;">Early data (optional, from session resumption)</td></tr><tr><td style="text-align: left;">1-RTT</td><td style="text-align: left;">Application data after handshake</td></tr></tbody></table><h3 id="packet-types" class="section-heading"><a href="#packet-types" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Packet Types</span></h3><p><strong>Long Header Packets:</strong></p><ul><li>Initial (type 0x00)</li><li>0-RTT (type 0x01)</li><li>Handshake (type 0x02)</li><li>Retry (type 0x03)</li></ul><p><strong>Short Header Packets:</strong></p><ul><li>1-RTT (application data)</li></ul><h3 id="frame-processing" class="section-heading"><a href="#frame-processing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Frame Processing</span></h3><p>Frames are processed in order within a packet. Key frame types:</p><table><thead><tr><th style="text-align: left;">Frame Type</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;">PADDING (0x00)</td><td style="text-align: left;">Padding for packet size</td></tr><tr><td style="text-align: left;">PING (0x01)</td><td style="text-align: left;">Keep-alive</td></tr><tr><td style="text-align: left;">ACK (0x02-0x03)</td><td style="text-align: left;">Acknowledgment</td></tr><tr><td style="text-align: left;">CRYPTO (0x06)</td><td style="text-align: left;">TLS handshake data</td></tr><tr><td style="text-align: left;">STREAM (0x08-0x0f)</td><td style="text-align: left;">Stream data</td></tr><tr><td style="text-align: left;">MAX_DATA (0x10)</td><td style="text-align: left;">Connection flow control</td></tr><tr><td style="text-align: left;">MAX_STREAM_DATA (0x11)</td><td style="text-align: left;">Stream flow control</td></tr><tr><td style="text-align: left;">NEW_CONNECTION_ID (0x18)</td><td style="text-align: left;">Issue new CID</td></tr><tr><td style="text-align: left;">PATH_CHALLENGE (0x1a)</td><td style="text-align: left;">Path validation</td></tr><tr><td style="text-align: left;">PATH_RESPONSE (0x1b)</td><td style="text-align: left;">Path validation response</td></tr><tr><td style="text-align: left;">CONNECTION_CLOSE (0x1c-0x1d)</td><td style="text-align: left;">Close connection</td></tr></tbody></table><h2 id="tls-integration" class="section-heading"><a href="#tls-integration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">TLS Integration</span></h2><h3 id="handshake-flow-client" class="section-heading"><a href="#handshake-flow-client" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Handshake Flow (Client)</span></h3><pre><code class="makeup erlang" translate="no"><span class="n">Client</span><span class="w">                                  </span><span class="n">Server</span><span class="w">
  </span><span class="err">│</span><span class="w">                                       </span><span class="err">│</span><span class="w">
  </span><span class="err">│</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Initial</span><span class="p" data-group-id="5400016402-1">[</span><span class="n">ClientHello</span><span class="p" data-group-id="5400016402-1">]</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w">
  </span><span class="err">│</span><span class="w">                                       </span><span class="err">│</span><span class="w">
  </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Initial</span><span class="p" data-group-id="5400016402-2">[</span><span class="n">ServerHello</span><span class="p" data-group-id="5400016402-2">]</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">│</span><span class="w">
  </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Handshake</span><span class="p" data-group-id="5400016402-3">[</span><span class="n">EncryptedExtensions</span><span class="p" data-group-id="5400016402-3">]</span><span class="w"> </span><span class="err">─</span><span class="err">│</span><span class="w">
  </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Handshake</span><span class="p" data-group-id="5400016402-4">[</span><span class="n">Certificate</span><span class="p" data-group-id="5400016402-4">]</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">│</span><span class="w">
  </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Handshake</span><span class="p" data-group-id="5400016402-5">[</span><span class="n">CertificateVerify</span><span class="p" data-group-id="5400016402-5">]</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">│</span><span class="w">
  </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Handshake</span><span class="p" data-group-id="5400016402-6">[</span><span class="n">Finished</span><span class="p" data-group-id="5400016402-6">]</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">│</span><span class="w">
  </span><span class="err">│</span><span class="w">                                       </span><span class="err">│</span><span class="w">
  </span><span class="err">│</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Handshake</span><span class="p" data-group-id="5400016402-7">[</span><span class="n">Finished</span><span class="p" data-group-id="5400016402-7">]</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w">
  </span><span class="err">│</span><span class="w">                                       </span><span class="err">│</span><span class="w">
  </span><span class="err">│</span><span class="err">◄</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="n">RTT</span><span class="p" data-group-id="5400016402-8">[</span><span class="n">Application</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5400016402-8">]</span><span class="w"> </span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">│</span></code></pre><h3 id="key-derivation" class="section-heading"><a href="#key-derivation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Derivation</span></h3><p>Keys are derived using HKDF with the following hierarchy:</p><pre><code class="makeup erlang" translate="no"><span class="w">                    </span><span class="n">PSK</span><span class="w"> </span><span class="p" data-group-id="3404304190-1">(</span><span class="ow">or</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="3404304190-1">)</span><span class="w">
                        </span><span class="err">│</span><span class="w">
                        </span><span class="err">▼</span><span class="w">
                 </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                 </span><span class="err">│</span><span class="w"> </span><span class="n">Early</span><span class="w"> </span><span class="n">Secret</span><span class="err">│</span><span class="w">
                 </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                        </span><span class="err">│</span><span class="w">
          </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
          </span><span class="err">▼</span><span class="w">             </span><span class="err">│</span><span class="w">             </span><span class="err">▼</span><span class="w">
    </span><span class="ss">client_early</span><span class="w">    </span><span class="ss">binder_key</span><span class="w">    </span><span class="ss">res_secret</span><span class="w">
    </span><span class="ss">traffic_secret</span><span class="w">                    </span><span class="err">│</span><span class="w">
                                      </span><span class="err">│</span><span class="w">
                        </span><span class="err">▼</span><span class="w">             </span><span class="err">│</span><span class="w">
              </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">       </span><span class="err">│</span><span class="w">
    </span><span class="p" data-group-id="3404304190-2">(</span><span class="n">EC</span><span class="p" data-group-id="3404304190-2">)</span><span class="n">DHE</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="n">Handshake</span><span class="w"> </span><span class="n">Secret</span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
              </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">       </span><span class="err">│</span><span class="w">
                      </span><span class="err">│</span><span class="w">               </span><span class="err">│</span><span class="w">
        </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w"> </span><span class="err">│</span><span class="w">
        </span><span class="err">▼</span><span class="w">             </span><span class="err">│</span><span class="w">             </span><span class="err">▼</span><span class="w"> </span><span class="err">│</span><span class="w">
   </span><span class="ss">client_hs</span><span class="w">      </span><span class="ss">server_hs</span><span class="w">    </span><span class="ss">derived</span><span class="err">│</span><span class="w">
   </span><span class="ss">traffic</span><span class="w">        </span><span class="ss">traffic</span><span class="w">         </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
   </span><span class="ss">secret</span><span class="w">         </span><span class="ss">secret</span><span class="w">          </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
                                  </span><span class="err">▼</span><span class="w">   </span><span class="err">│</span><span class="w">
                        </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                        </span><span class="err">│</span><span class="n">Master</span><span class="w"> </span><span class="n">Secret</span><span class="err">│</span><span class="w">
                        </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                               </span><span class="err">│</span><span class="w">
              </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
              </span><span class="err">▼</span><span class="w">                </span><span class="err">│</span><span class="w">                </span><span class="err">▼</span><span class="w">
        </span><span class="ss">client_app</span><span class="w">         </span><span class="ss">server_app</span><span class="w">      </span><span class="ss">resumption</span><span class="w">
        </span><span class="ss">traffic</span><span class="w">            </span><span class="ss">traffic</span><span class="w">         </span><span class="ss">master</span><span class="w">
        </span><span class="ss">secret</span><span class="w">             </span><span class="ss">secret</span><span class="w">          </span><span class="ss">secret</span></code></pre><h2 id="stream-management" class="section-heading"><a href="#stream-management" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stream Management</span></h2><h3 id="stream-ids" class="section-heading"><a href="#stream-ids" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stream IDs</span></h3><p>Stream IDs encode initiator and directionality:</p><table><thead><tr><th style="text-align: left;">Bits 1-0</th><th style="text-align: left;">Stream Type</th></tr></thead><tbody><tr><td style="text-align: left;">0x00</td><td style="text-align: left;">Client-initiated, bidirectional</td></tr><tr><td style="text-align: left;">0x01</td><td style="text-align: left;">Server-initiated, bidirectional</td></tr><tr><td style="text-align: left;">0x02</td><td style="text-align: left;">Client-initiated, unidirectional</td></tr><tr><td style="text-align: left;">0x03</td><td style="text-align: left;">Server-initiated, unidirectional</td></tr></tbody></table><h3 id="stream-states" class="section-heading"><a href="#stream-states" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stream States</span></h3><p><strong>Sending side:</strong></p><ul><li>Ready → Send → Data Sent → Data Recvd (terminal)</li><li>Ready → Reset Sent → Reset Recvd (terminal)</li></ul><p><strong>Receiving side:</strong></p><ul><li>Recv → Size Known → Data Recvd → Data Read (terminal)</li><li>Recv → Reset Recvd → Reset Read (terminal)</li></ul><h2 id="flow-control" class="section-heading"><a href="#flow-control" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Flow Control</span></h2><h3 id="connection-level" class="section-heading"><a href="#connection-level" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Connection-Level</span></h3><ul><li><code class="inline">MAX_DATA</code> frame advertises connection-level receive window</li><li>Sender tracks <code class="inline">data_sent</code> against peer's <code class="inline">max_data</code></li><li>Receiver sends <code class="inline">MAX_DATA</code> updates when buffer space is freed</li></ul><h3 id="stream-level" class="section-heading"><a href="#stream-level" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stream-Level</span></h3><ul><li><code class="inline">MAX_STREAM_DATA</code> frame advertises per-stream receive window</li><li>Similar tracking at stream granularity</li><li><code class="inline">BLOCKED</code> and <code class="inline">STREAM_BLOCKED</code> frames signal flow control limits</li></ul><h2 id="congestion-control" class="section-heading"><a href="#congestion-control" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Congestion Control</span></h2><p>The implementation uses NewReno congestion control (RFC 9002):</p><h3 id="states" class="section-heading"><a href="#states" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">States</span></h3><ul><li><strong>Slow Start</strong>: Exponential growth until <code class="inline">ssthresh</code></li><li><strong>Congestion Avoidance</strong>: Linear growth after slow start</li><li><strong>Recovery</strong>: After packet loss detection</li></ul><h3 id="key-variables" class="section-heading"><a href="#key-variables" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Variables</span></h3><table><thead><tr><th style="text-align: left;">Variable</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">cwnd</code></td><td style="text-align: left;">Congestion window (bytes)</td></tr><tr><td style="text-align: left;"><code class="inline">ssthresh</code></td><td style="text-align: left;">Slow start threshold</td></tr><tr><td style="text-align: left;"><code class="inline">bytes_in_flight</code></td><td style="text-align: left;">Unacknowledged bytes</td></tr></tbody></table><h3 id="on-ack" class="section-heading"><a href="#on-ack" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">On ACK</span></h3><pre><code class="makeup erlang" translate="no"><span class="k">if</span><span class="w"> </span><span class="ss">bytes_acked</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="ss">cwnd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nc">ssthresh</span><span class="p">:</span><span class="w">
        </span><span class="ss">cwnd</span><span class="w"> </span><span class="o">+</span><span class="o">=</span><span class="w"> </span><span class="ss">bytes_acked</span><span class="w">  </span><span class="p">#</span><span class="w"> </span><span class="n">Slow</span><span class="w"> </span><span class="ss">start</span><span class="w">
    </span><span class="nc">else</span><span class="p">:</span><span class="w">
        </span><span class="ss">cwnd</span><span class="w"> </span><span class="o">+</span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5844308268-1">(</span><span class="ss">bytes_acked</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="ss">max_datagram_size</span><span class="p" data-group-id="5844308268-1">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="ss">cwnd</span><span class="w">  </span><span class="p">#</span><span class="w"> </span><span class="n">Congestion</span><span class="w"> </span><span class="ss">avoidance</span></code></pre><h3 id="on-loss" class="section-heading"><a href="#on-loss" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">On Loss</span></h3><pre><code class="makeup erlang" translate="no"><span class="ss">ssthresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">max</span><span class="p" data-group-id="0815264968-1">(</span><span class="ss">cwnd</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="ss">max_datagram_size</span><span class="p" data-group-id="0815264968-1">)</span><span class="w">
</span><span class="ss">cwnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">ssthresh</span></code></pre><h2 id="loss-detection" class="section-heading"><a href="#loss-detection" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Loss Detection</span></h2><h3 id="packet-loss-detection" class="section-heading"><a href="#packet-loss-detection" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Packet Loss Detection</span></h3><p>Two mechanisms detect packet loss:</p><ol><li><p><strong>Packet Threshold</strong>: A packet is lost if a later packet in the same number space has been acknowledged and the gap exceeds the threshold (default: 3).</p></li><li><p><strong>Time Threshold</strong>: A packet is lost if it was sent more than <code class="inline">max(smoothed_rtt + max(4 * rtt_var, 1ms), 1.125 * smoothed_rtt)</code> before the largest acknowledged packet.</p></li></ol><h3 id="probe-timeout-pto" class="section-heading"><a href="#probe-timeout-pto" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Probe Timeout (PTO)</span></h3><p>When no ACKs are received, PTO triggers retransmission:</p><pre><code class="makeup erlang" translate="no"><span class="n">PTO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">smoothed_rtt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">max</span><span class="p" data-group-id="6112208441-1">(</span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="ss">rtt_var</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="ss">ms</span><span class="p" data-group-id="6112208441-1">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">max_ack_delay</span></code></pre><p>After PTO expires:</p><ol><li>Send 1-2 ack-eliciting packets</li><li>Double PTO for next timeout</li><li>After persistent congestion, reset to slow start</li></ol><h2 id="connection-migration" class="section-heading"><a href="#connection-migration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Connection Migration</span></h2><h3 id="path-validation" class="section-heading"><a href="#path-validation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Path Validation</span></h3><p>When the peer's address changes:</p><ol><li>Send <code class="inline">PATH_CHALLENGE</code> frame with random 8-byte data</li><li>Peer responds with <code class="inline">PATH_RESPONSE</code> containing same data</li><li>Path is validated upon receiving correct response</li></ol><h3 id="migration-process" class="section-heading"><a href="#migration-process" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Migration Process</span></h3><ol><li>Detect new remote address</li><li>Initiate path validation</li><li>Continue using old path until validation completes</li><li>Switch to new path upon successful validation</li><li>Reset congestion controller for new path</li></ol><h2 id="key-update" class="section-heading"><a href="#key-update" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Update</span></h2><p>RFC 9001 Section 6 defines key update mechanism:</p><ol><li>Sender increments key phase bit in packet header</li><li>Derives new keys from current application secrets</li><li>Receiver detects phase change and derives matching keys</li><li>Old keys retained briefly for reordered packets</li></ol><pre><code class="makeup erlang" translate="no"><span class="ss">next_app_secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HKDF</span><span class="o">-</span><span class="n">Expand</span><span class="o">-</span><span class="n">Label</span><span class="p" data-group-id="8120074512-1">(</span><span class="ss">current_app_secret</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;quic ku&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">hash_len</span><span class="p" data-group-id="8120074512-1">)</span></code></pre><h2 id="connection-id-management" class="section-heading"><a href="#connection-id-management" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Connection ID Management</span></h2><h3 id="local-cid-pool" class="section-heading"><a href="#local-cid-pool" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Local CID Pool</span></h3><ul><li>Generate and issue CIDs via <code class="inline">NEW_CONNECTION_ID</code> frame</li><li>Track sequence numbers and stateless reset tokens</li><li>Retire old CIDs via <code class="inline">RETIRE_CONNECTION_ID</code></li></ul><h3 id="peer-cid-pool" class="section-heading"><a href="#peer-cid-pool" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Peer CID Pool</span></h3><ul><li>Store CIDs received from peer</li><li>Select appropriate CID for path</li><li>Respect <code class="inline">active_connection_id_limit</code> transport parameter</li></ul>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="readme.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
erlang_quic
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/quic/0.6.5" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/quic/0.6.5">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/quic/0.6.5/show/docs/DESIGN.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="quic.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.39.1) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
